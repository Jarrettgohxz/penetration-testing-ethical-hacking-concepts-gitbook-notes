# 5. System enumeration (via shell)

### 5.1 Gaining a shell

{% embed url="https://jarrettgxz-sec.gitbook.io/penetration-testing-ethical-hacking-concepts/hardware-exploitation/techniques/uart-shell" %}

We have to first identify the device name of the USB-UART adapter:

```shellscript
$ ls /dev | grep -i usb
ttyUSB0
```

&#x20;used `picocom` to retrieve a shell, with the baud rate as **115200** (a common first guess)

```shellscript
$ picocom -b 115200 /dev/ttyUSB0
```

* I received a log output with non-gibberish text
  * this means that the correct baud rate was chosen
* A "Hit enter to continue..." message was shown
  * From there, we are able to pop a **BusyBox v1.7.2 shell**

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### 5.2 General enumeration

List of enumeration steps:

1. Read through the initial boot logs
2. Identify firmware version (to verify if the current version is still vulnerable)

* `nvram`&#x20;
* build date

3. Identify architecture
4. Identify `httpd` binary locations
5. ...



#### 5.2.1 Boot logs

1. Boot version

```shellscript
CFE version 5.100.138.11 based on BBP 1.0.37 for BCM947XX (32bit,SP,LE)
Build Date: 11/23/11 12:16:38 CST (wzh@cybertan)
Copyright (C) 2000-2008 Broadcom Corporation.
```

2. Commands

The following compiles a few interesting commands listed in the boot logs:

```shellscript
CMD: [ifconfig eth0 -addr=192.168.1.1 -mask=255.255.255.0]
CMD: [load -raw -addr=0x807ae0f0 -max=0x1851f10 :]
CMD: [boot -raw -z -addr=0x80001000 -max=0x6ff000 flash0.os:]
cmd=[/sbin/hotplug2 --coldplug & ]
cmd=[misc -t get_mac -w 3 ]
cmd=[misc -t get_wsc_pin -w 3 ]
cmd=[misc -t get_pa0idxval -w 3 ]
cmd=[misc -t get_pa1idxval -w 3 ]

cmd=[insmod emf ]
cmd=[insmod igs ]
cmd=[insmod ctf ]
Needed modules: et wl ip6table_mangle ip6table_filter ip6t_rt ip6t_frag ip6t_ipv6header ip6t_REJECT ip6t_LOG ip6t_ipv6range tunnel4 sit tunnel6 ip6_tunnel nf_conntrack_h323.ko nf_nat_h323.ko xt_TCPMSS.ko 
cmd=[insmod et ]
cmd=[insmod wl ]
cmd=[insmod ip6table_mangle ]
cmd=[insmod ip6table_filter ]
cmd=[insmod ip6t_rt ]
cmd=[insmod ip6t_frag ]
cmd=[insmod ip6t_ipv6header ]
cmd=[insmod ip6t_REJECT ]
cmd=[insmod ip6t_LOG ]
cmd=[insmod ip6t_ipv6range ]
cmd=[insmod tunnel4 ]
cmd=[insmod sit ]
cmd=[insmod tunnel6 ]
cmd=[insmod ip6_tunnel ]
cmd=[insmod nf_conntrack_h323.ko ]
cmd=[insmod nf_nat_h323.ko ]
cmd=[insmod xt_TCPMSS.ko ]
cmd=[insmod dnshook ]

cmd=[iptables -t nat -F wlwarning2wan ]
cmd=[iptables -F wlwarningaccept ]
cmd=[ip6tables -t mangle -F wlwarning2wan ]
cmd=[ip6tables -t filter -F wlwarningaccept ]
cmd=[tftpd -s /tmp -c -l -P E150 ]

cmd=[cron ]
cmd=[httpd ]
cmd=[/tmp/gn-httpd -p 51000 -G ]
cmd=[touch /tmp/hosts ]
cmd=[dnsmasq -R -h -i br1 -i br0 -c 0 -r /tmp/resolv.conf ]

cmd=[route del -net 224.0.0.0 netmask 240.0.0.0 dev br0 ]
cmd=[route add -net 224.0.0.0 netmask 240.0.0.0 dev br0 ]
cmd=[cesmDNS -o /tmp/.mdns_host_info -d -h CISCO007 -l 192.168.1.1 ]
cmd=[/tmp/gn-dhcpd -cf /tmp/dhcpd-br1.conf -lf /tmp/dhcpd-br1.leases -df /tmp/udhcpd-br1.leases -pf /var/run/dhcpd-br1.pid br1 ]
cmd=[dhcpd -cf /tmp/dhcpd-br0.conf -lf /tmp/dhcpd.leases -df /tmp/udhcpd.leases -pf /var/run/dhcpd.pid br0 ]

cmd=[/bin/eapd ]
cmd=[nas ]
cmd=[killall wps_monitor ]
cmd=[killall wps_ap ]
cmd=[killall wps_enr ]
cmd=[/bin/wps_monitor ]
cmd=[netbios /tmp/samba/lib/netbios.conf ]

cmd=[nlinkd ]
cmd=[killall -1 radvd ]
cmd=[/sbin/monitor_cable ]
cmd=[/usr/sbin/arp -c ]
cmd=[iptables -t filter -A FORWARD -i br1 -d 192.168.1.0/24 -j DROP ]
cmd=[iptables -t filter -A FORWARD -i br0 -d 192.168.33.0/24 -j DROP ]
cmd=[iptables -t nat -A PREROUTING -i br1 -p tcp -d 192.168.33.1 --dport 80 -j DNAT --to-destination 192.168.33.1:51000 ]
cmd=[touch /tmp/hosts ]

cmd=[/usr/sbin/ip -6 addr flush dev vlan2 scope global ]
cmd=[ip6tables -t filter -F ]
cmd=[ip6tables -t filter -Z ]
cmd=[ip6tables -t mangle -F ]
cmd=[ip6tables -t mangle -Z ]


```

**Discussion of important commands:**

a.&#x20;



3. Other useful information

```shellscript
Linux version 2.6.22 (wzh@cybertan) (gcc version 4.2.3) #2 Wed Feb 15 20:33:15 CST 2012
Kernel command line: root=/dev/mtdblock2 console=ttyS0,115200 init=/sbin/preinit
```



#### 5.2.2 Firmware version

```shellscript
# firmware version
$ nvram get firmware_version
$ nvram show | grep -i version

# uname
$ uname -v
Wed Feb 15 20:33:15 CST 2012
```

* We have identified that the build date is **Feb 15 2012**

With the following simple Google dork:

```
site:downloads.linksys.com "e1200"
```

I managed to find details for a few release notes, with the earliest on **Aug 28, 2013**, and the latest on **Jan 5, 2018**

1. [https://downloads.linksys.com/downloads/866/465/E1200\_v2\_v2.2\_FwReleaseNotes,0.txt](https://downloads.linksys.com/downloads/866/465/E1200_v2_v2.2_FwReleaseNotes,0.txt)
2. [https://downloads.linksys.com/downloads/releasenotes/E1200\_v2\_v2.2\_FwReleaseNotes.txt](https://downloads.linksys.com/downloads/releasenotes/E1200_v2_v2.2_FwReleaseNotes.txt)

It is highly probable that the current firmware on the device has not been patched at all, and would most likely still be vulnerable to the CVEs we have discussed before.

#### 5.2.3 Further enumeration

```shellscript
# list all the available binaries

$ echo $PATH
/usr/bin:/bin:/usr/sbin:/sbin

$ ls /usr/bin
$ ls /bin
$ ls /usr/sbin
$ ls /sbin
```

```shellscript
# architecture
$ uname -u
$ cat /etc/version
$ cat /etc/banner
$ cat /etc/issue

 
# stack protections
$ cat /proc/cpuinfo
$ cat /proc/sys/kernel/randomize_va_space

```

### 5.3 `httpd` binary (CVE)

...

```shellscript
# common tools
$ which httpd
$ ps auxw | grep httpd
$ find / -type f -name '*httpd*' 2>/dev/null

# from /etc/inittab and /etc/init.d 
$ cat /etc/inittab
$ grep -R "httpd" /etc/init.d 2>/dev/null
```



