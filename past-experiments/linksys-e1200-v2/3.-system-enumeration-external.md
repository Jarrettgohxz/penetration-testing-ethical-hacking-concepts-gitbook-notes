# 3. System enumeration (external)

### 3.1 Automatic IP lease (DHCP)

An ethernet cable will be used to connect the "Ethernet" port of the router and a test machine (running Ubuntu OS). We will be using Wireshark to view the live network traffic flowing between the router and test machine.

Right after the ethernet cable is plugged in, a bunch of network traffic starts flowing on the Wireshark screen. The particular type of traffic of interest would be **DHCP:**

<figure><img src="../../.gitbook/assets/image (113).png" alt=""><figcaption></figcaption></figure>

From the image, we can see the [DHCP DORA ](https://www.pynetlabs.com/what-is-dhcp/)process: Discover, Offer, Request, ACK.

### 3.2 Network services scan (Nmap)

* `<host>` will be the IP address of the local gateway (eg. **192.168.1.1**)
* The following scan types outlined below will be performed on both the LAN ("Ethernet") and WAN  ("Internet") interfaces of the router

<figure><img src="../../.gitbook/assets/image (115).png" alt=""><figcaption></figcaption></figure>

#### 3.2.1 TCP scan

```shellscript
$ sudo nmap -sS -p- -T4 -n -Pn  <host>
```

#### 3.2.2 UDP scan

```shellscript
$ sudo nmap -sU -F -T4 -n -Pn --max-retries 1 <host>
```

> Note: UDP scans are much slower than TCP because they often don't receive a response, forcing Nmap to wait for a timeout

Hence, the following flags can be used to make the UDP scan more efficient::

1. &#x20;`--max-retries` is important to cap the max retransmission for UDP scans
2. `-F` scans fewer ports

**Limitations of the UDP scan**

Notice that this particular UDP scan did not return port 67, even though it is open and used in the DHCP process discussed earlier. We can use **netcat** to confirm this:

```shellscript
$ nc -u <host> 67
Connection to 192.168.1.1 67 port [udp/bootps] succeeded!

$ nc -u <host> 70 # test with other port that is not open
$ # returns without any output 
```

#### 3.2.3 Targeted TCP+UDP scan

Now that we have discovered the open TCP and UDP ports, we can perform a targeted scan on the found ports. This will involve the following additional scan types:

1. `-sC`: default script scan
2. `-sV`: version detection

{% code overflow="wrap" %}
```shellscript
$ sudo nmap -sC -sV -p T:<found_TCP_ports>,U:<found_UDP_ports> -n -Pn --max-retries 1 <host>

# eg.
$ sudo nmap -sC -sV -sS -sU -p T:80,U:53,1900 -n -Pn --max-retries 1 192.168.1.1
```
{% endcode %}

#### 3.2.4 LAN interface scan results

**TCP scan**

<figure><img src="../../.gitbook/assets/image (120).png" alt=""><figcaption></figcaption></figure>

**UDP scan**

<figure><img src="../../.gitbook/assets/image (122).png" alt=""><figcaption></figcaption></figure>

**Targeted TCP+UDP scan**

```shellscript
$ sudo nmap -sV -sS -sU -p T:80,1780,1990,51000,U:53,1900,32768,1900 -n -Pn --max-retries 1 192.168.1.1
```

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

#### 3.2.5 WAN interface scan results

Since the WAN interface of the router typically acts as a DHCP client, rather than a server, it will not be able to lease an IP address to our host. To fix this, we can run a DHCP server (`dnsmasq`), and configure a static IP address on our host:

```shellscript
$ vim /etc/dnsmasq.conf
interface=<iface>
dhcp-range=<dhcp_start_range>,<dhcp_end_range>,<lease_time>

$ sudo systemctl restart dnsmasq.service
```

```shellscript
$ sudo ip link add addr <static_IP_addr> dev <iface>

# eg.
$ ifconfig
...
enx123
...

$ sudo ip link add addr 192.168.1.88 dev enx123
```

**TCP scan**



**UDP scan**



**Targeted TCP+UDP scan**



Refer to the following links for more information on the Nmap options:

{% embed url="https://jarrettgxz-sec.gitbook.io/penetration-testing-ethical-hacking-concepts/2-network-port-scan-services-enumeration/nmap" %}

{% embed url="https://jarrettgxz-sec.gitbook.io/penetration-testing-ethical-hacking-concepts/tools-services/network-recon-and-attacks/nmap-general-overview#scan-optimization" %}
