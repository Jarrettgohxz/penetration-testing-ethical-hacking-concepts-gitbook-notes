# Exploiting domain trusts

### Resources

1. **DCSync attack**

{% embed url="https://www.extrahop.com/resources/attacks/dcsync" %}

{% embed url="https://tools.thehacker.recipes/mimikatz/modules/lsadump/dcsync" %}

2. **Kerberos notes**

{% embed url="https://jarrettgxz-sec.gitbook.io/windows/active-directory-ad/authentication-methods/kerberos" %}

3. Additional domain trusts exploitation resources

{% embed url="https://redfoxsec.com/blog/domain-trusts-exploitation-playbook/" %}

4. **KERB\_VALIDATION\_INFO**

* A structure where the `ExtraSids` field is specified

{% embed url="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/69e86ccc-85e3-41b9-b514-7d969cd0ed73" %}

### Terminologies

1. **Kerberos Ticket Granting Ticket** _(_**KRBTGT**)

* The service account for the Key Distribution Center (KDC) service
* This account is used to encrypt and sign all Kerberos tickets for the domain



2. **Golden ticket**

* A TGT is signed with the **KRBTGT** account's password hash
* Thus, with access to this hash, we will be able to forge a TGT for any user of our choice
* This ticket is known as a "_**Golden Ticket**_"

### Overview of exploiting domain trusts

In this attack, we abuse the trusts between domains in a forest. A particular trust between a parent and child domain can be exploited to forge an **Inter-Realm TGT** that can be used to gain access to the parent domain (refer to the sections below for more information).

#### Golden Ticket attack

Refer to the "_**Terminologies**_" section above for more details on the Golden Ticket.

In a Golden Ticket attack, an attacker who has obtained the **KRBTGT** account hash for a domain can forge their own Ticket Granting Ticket (TGT) for any user of their choice. This forged TGT, known as a Golden Ticket, is signed with the **KRBTGT** hash, making it appear valid to the domainâ€™s Key Distribution Center (KDC).&#x20;

This particular TGT can be used to request service tickets (TGS) for any service as the specified user, effectively gaining unrestricted access within the domain (eg. _Administrator_).

> Note that without domain trust relationships, a golden ticket crafted for a particular domain will only work within that domain. Refer to the **Inter-realm TGT**s section below to understand how domain trusts can be exploited to further our privileges to other domains.

#### DC Sync attack

Given that we have obtained administrative privileges on a machine, we can perform a DC Sync attack to recover the **KRBTGT** account password hash. The found hash can be used to create an Inter-Realm TGT to exploit any domain trust configurations.

#### Inter-Realm TGTs

Inter-Realm TGTs are used to provide access to resources in other domains. A two-way relationship between a child and parent domain can be exploited to gain full access to the parent domain (refer to example below).&#x20;

### Example

...

#### Inter-Realm TGT

...



