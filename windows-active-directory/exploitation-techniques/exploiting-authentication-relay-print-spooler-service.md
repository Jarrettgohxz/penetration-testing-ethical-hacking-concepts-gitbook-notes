# Exploiting authentication relay \~ Print Spooler Service

### Resources

1. **Print System Remote Protocol** (**MS-RPRN**)

{% embed url="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/d42db7d5-f141-4466-8f47-0a4be14e2fc1" %}

2. &#x20;**Print Spooler Service**

{% embed url="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-prsod/7262f540-dd18-46a3-b645-8ea9b59753dc" %}

A certain bug or "feature" in Microsoft Print System Remote Protocol (MS-RPRN) allows a domain user to remotely force a target host running the Print Spooler service to authenticate to an arbitary IP address.

> Note that the attack discussed below can be unstable, and may cause the Print Spooler service to crash, and the success of the attack varies.

To exploit this flaw, we need to meet the following requirements:

1. A valid set of AD account credentials

* To have access to machines within the AD network, to perform required tasks in the other steps

2. Network connectivity to the target's SMB service
3. The target host must be running the Print Spooler service
4. The hosts involved must not have SMB signing enforced

The following discusses how to explore the requirements listed above.

#### #3 The target host must be running the Print Spooler service

We can utilize a few WMI queries from another machine on the network (with network connectivity to the target host) to query the current state:

```powershell
PS> GWMI Win32_Printer -ComputerName <target>
# OR
PS> Get-PrinterPort -ComputerName <target>
```

> Note that the success of this may vary, as Microsoft has been limiting the view on these ports from the network perspective.

#### #4 The hosts involved must not have SMB signing enabled

We can use nmap to enumerate the SMB signing enforcement on our target hosts:

{% code overflow="wrap" %}
```sh
$ nmap --script=smb2-security-mode -p445 <target1> <target2>
```
{% endcode %}

Ideally, we look for the following output: "**Message signing enabled but not required"**.

### Exploitation

...



