# Common conventions

### 1. Function calls

{% embed url="https://textbook.cs161.org/memory-safety/x86.html#28-x86-function-calls" %}

Following the steps outlined in the textbook above regarding function calls, I will list out the corresponding **x86** (32-bit) assembly codes. Note that for this example, we will draw the memory layout with the highest address at the _**top**_, while the lower addresses appear at the _**bottom**_ visually. However, the `EBP` and `ESP` will still point to the higher and lower addresses of the stack frame respectively.

#### 1.1 Push arguments on the stack

> Remember that **x86** passes arguments by pushing them onto the stack&#x20;

**1.1.1 State of the memory BEFORE**

```

 Highest address	|----->	+------------------------+ <--EBP
			|	| Stack frame for "main" |			 
			|	|------------------------| <--ESP			 
			|	| 			 |
			|	|------------------------|			 
			|	|			 |
			|	|------------------------|
		STACK---|	|			 |		 	
			|	|------------------------|
			|	|			 |	
			|	|------------------------|
			|	|			 |	
			|	|------------------------|
			|	|			 |	
			|	|------------------------|
			|	|	...		 |	
			|----->	|------------------------|
			|	|  Code for "test"	 |	 	
		CODE---	|	|------------------------|
			|	|  Code for "main"	 | <-- EIP	 	
 Lowest address		|----->	|------------------------| 

```

**1.1.2 State of the memory AFTER instruction**

```nasm
push arg1 ; push first arg1 to stack
push arg2 ; push second arg2 to stack
```

<pre><code>
 Highest address	|----->	+------------------------+ &#x3C;--EBP
			|	| Stack frame for "main" |			 
			|	|------------------------| 			 
			|	|        arg2	         |
			|	|------------------------|			 
			|	|	 arg1		 |
			|	|------------------------| &#x3C;--<a data-footnote-ref href="#user-content-fn-1">ESP</a>
		STACK---|	|			 |		 	
			|	|------------------------|
			|	|			 |	
			|	|------------------------|
			|	|			 |	
			|	|------------------------|
			|	|			 |	
			|	|------------------------|
			|	|	...		 |	
			|----->	|------------------------|
			|	|  Code for "test"	 |	 	
		CODE---	|	|------------------------|
			|	|  Code for "main"	 | &#x3C;-- EIP	 	
 Lowest address		|----->	|------------------------| 

</code></pre>

* As we can see from the stack content after the instruction, `arg2` is pushed first before `arg1`. This is because arguments are pushed onto the stack in reverse order

#### 1.2 Call the function

* This step can be broken down into 2 separate assembly commands: **push** and **jmp**

#### 1.2.1 Push the old `EIP` on the stack

* Since the value in the `EIP` register is about to be changed to point to the function address, we need to save its current value onto the stack before we overwrite it with a new value

**1.2.1.1 State of the memory BEFORE**

<pre><code>
 Highest address	|----->	+------------------------+ &#x3C;--EBP
			|	| Stack frame for "main" |			 
			|	|------------------------| 			 
			|	|        arg2	         |
			|	|------------------------|			 
			|	|	 arg1		 |
			|	|------------------------| 
		STACK---|	|    Old EIP value	 |		 	
			|	|------------------------| &#x3C;--<a data-footnote-ref href="#user-content-fn-2">ESP</a>
			|	|			 |	
			|	|------------------------|
			|	|			 |	
			|	|------------------------|
			|	|			 |	
			|	|------------------------|
			|	|	...		 |	
			|----->	|------------------------|
			|	|  Code for "test"	 |	 	
		CODE---	|	|------------------------|
			|	|  Code for "main"	 | &#x3C;-- EIP	 	
 Lowest address		|----->	|------------------------| 

</code></pre>

**1.2.1.2 State of the memory AFTER instruction**

```nasm
push eip
```

```

 Highest address	|----->	+------------------------+ <--EBP
			|	| Stack frame for "main" |			 
			|	|------------------------| 			 
			|	|        arg2	         |
			|	|------------------------|			 
			|	|	 arg1		 |
			|	|------------------------| 
		STACK---|	|    Old EIP value	 |		 	
			|	|------------------------| <--ESP
			|	|			 |	
			|	|------------------------|
			|	|			 |	
			|	|------------------------|
			|	|			 |	
			|	|------------------------|
			|	|	...		 |	
			|----->	|------------------------|
			|	|  Code for "test"	 |	 	
		CODE---	|	|------------------------|
			|	|  Code for "main"	 | <-- EIP	 	
 Lowest address		|----->	|------------------------| 

```

#### 1.2.2 `jmp` to the function address

...







[^1]: ESP decrements by 4\*2 = 8

[^2]: ESP decrement after pushing old EIP
